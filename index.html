<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Virginia Legends Cricket - Admin</title>
<style>
    :root {
      --primary: #3a6ea5;
      --primary-dark: #214f7a;
      --success: #28a745;
      --danger: #dc3545;
      --info: #007bff;
      --bg: #eef2f7;
      --highlight: #d1ecf1;
      --text: #333;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 10px;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
    }

    .tab-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 10;
      padding: 10px 0;
      border-bottom: 1px solid #ccc;
    }

    .tab {
      padding: 10px 16px;
      margin: 5px;
      border-radius: 4px;
      color: white;
      background: var(--primary);
      cursor: pointer;
    }

    .tab.active {
      background: var(--primary-dark);
    }

    input, .btn {
      font-size: 1em;
      margin: 4px 0;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    input {
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .btn {
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn.submit { background: var(--success); color: white; }
    .btn.clear { background: var(--danger); color: white; }
    .btn.export { background: var(--info); color: white; }

    .match-input > div {
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
      display: block;
    }

    th, td {
      padding: 8px;
      border: 1px solid #bbb;
      text-align: center;
    }

    th {
      background: var(--primary);
      color: white;
    }

    .highlight {
      background: var(--highlight);
    }

    .button-row {
      text-align: center;
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .team-group, .group-table {
      margin: 20px auto;
      max-width: 700px;
    }

    .result-summary {
      margin-top: 8px;
      font-size: 0.9em;
      color: var(--text);
    }

    #upload-status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      display: none;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @media (max-width: 600px) {
      input, .btn { font-size: 0.9em; }
      .match-input > div { padding: 10px; }
    }
  
    @media (max-width: 768px) {
      h1 { font-size: 1.4rem; }
      .tab-container { flex-direction: column; align-items: center; }
      .tab { width: 90%; text-align: center; }
      .match-input > div, .team-group, .group-table {
        padding: 10px; margin: 10px auto; width: 95%;
      }
      input, .btn { font-size: 0.9em; padding: 8px; width: 100%; }
      table { font-size: 0.85em; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.2rem; }
      input, .btn { font-size: 0.85em; padding: 6px; }
      .tab { font-size: 0.9em; }
      table th, table td { padding: 4px; }
    }

    #login-container {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100vh; background: #f5f5f5;
    }
    #admin-panel { display: none; }
</style>
</head>
<body>

<div id="login-container">
  <h2>Admin Login</h2>
  <input id="admin-pass" placeholder="Enter Password" style="padding:10px; font-size:16px;" type="password"/>
  <button onclick="checkPassword()" style="margin-top:10px; padding:10px 20px;">Login</button>
  <p id="error-msg" style="color:red; font-weight:bold;"></p>
</div>

<div id="admin-panel" style="display:none;">
  <button onclick="logout()" style="position:fixed; top:10px; right:10px; padding:8px 12px; background:#c62828; color:white; border:none; border-radius:4px; font-weight:bold;">Logout</button>
  
  <div style="margin-bottom: 10px;">
    <div id="user-status">Checking login status...</div>
    <div id="login-form">
      <input id="email" placeholder="Admin email" type="email"/><br/>
      <input id="password" placeholder="Password" type="password"/><br/>
      <button id="login-btn">Login</button>
    </div>
    <button id="logout-btn" style="display:none; margin-top:5px;">Logout</button>
  </div>

  <div id="upload-status"></div>

  <h1>Virginia Legends Cricket</h1>
  <div class="tab-container" id="tabs"></div>
  <div id="teamInputs"></div>
  <div class="match-input" id="matchInputs"></div>
  
  <div class="button-row">
    <button class="btn clear" onclick="clearAll()">Clear All Data</button>
    <button class="btn export firebase-export" id="upload-tournament-btn" style="display:none;">Upload Tournament Results</button>
    <button class="btn export firebase-export" id="upload-match-btn" style="display:none;">Upload Match Scores</button>
  </div>
  
  <div id="tables"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCoyOrKtUN9ZIfqU6adHIWNXS4-pEGOKo8",
  authDomain: "vlegends-cricket.firebaseapp.com",
  projectId: "vlegends-cricket",
  storageBucket: "vlegends-cricket.appspot.com",
  messagingSenderId: "135296590044",
  appId: "1:135296590044:web:84ce8e5413b71ac9605419"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);

function showStatus(message, isError = false) {
  const statusEl = document.getElementById('upload-status');
  statusEl.textContent = message;
  statusEl.className = isError ? 'status-error' : 'status-success';
  statusEl.style.display = 'block';
  
  setTimeout(() => {
    statusEl.style.display = 'none';
  }, 5000);
}

async function uploadToFirebase(filename, content) {
  try {
    // Check if user is authenticated or admin override is enabled
    if (!window.firebaseUser && !window.adminOverride) {
      showStatus("Please log in to upload files.", true);
      return;
    }
    
    // Validate content
    if (!content) {
      showStatus("No data to upload.", true);
      return;
    }
    
    showStatus("Uploading " + filename + "...");
    console.log("Starting upload for:", filename);
    console.log("Content preview:", content.substring(0, 200));
    
    // Create blob with proper MIME type
    const blob = new Blob([content], { type: "text/csv;charset=utf-8" });
    console.log("Blob created, size:", blob.size);
    
    // Create storage reference
    const storageRef = ref(storage, filename);
    console.log("Storage reference created for:", filename);
    
    // Upload the file
    const snapshot = await uploadBytes(storageRef, blob);
    console.log("Upload completed:", snapshot);
    
    // Get download URL
    const downloadURL = await getDownloadURL(snapshot.ref);
    console.log("Download URL:", downloadURL);
    
    showStatus(filename + " uploaded successfully!");
    
  } catch (error) {
    console.error("Detailed upload error:", error);
    console.error("Error code:", error.code);
    console.error("Error message:", error.message);
    
    let errorMessage = "Upload failed: ";
    if (error.code === 'storage/unauthorized') {
      errorMessage += "Unauthorized access. Check Firebase rules.";
    } else if (error.code === 'storage/invalid-argument') {
      errorMessage += "Invalid file data.";
    } else if (error.code === 'storage/quota-exceeded') {
      errorMessage += "Storage quota exceeded.";
    } else {
      errorMessage += error.message;
    }
    
    showStatus(errorMessage, true);
  }
}

// Make function available globally
window.uploadToFirebase = uploadToFirebase;

function setupAuthUI() {
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const userStatus = document.getElementById("user-status");
  const loginForm = document.getElementById("login-form");
  const uploadButtons = document.querySelectorAll(".firebase-export");

  // Set up upload button event listeners
  const tournamentBtn = document.getElementById("upload-tournament-btn");
  const matchBtn = document.getElementById("upload-match-btn");
  
  if (tournamentBtn) {
    tournamentBtn.onclick = () => uploadToFirebase('tournament_results.csv', generateTournamentCSV());
  }
  
  if (matchBtn) {
    matchBtn.onclick = () => uploadToFirebase('match_scores.csv', generateMatchCSV());
  }

  if (loginBtn) {
    loginBtn.onclick = async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      
      if (!email || !password) {
        showStatus("Please enter both email and password.", true);
        return;
      }
      
      try {
        showStatus("Signing in...");
        await signInWithEmailAndPassword(auth, email, password);
        showStatus("Successfully logged in!");
      } catch (error) {
        console.error("Login error:", error);
        showStatus("Login failed: " + error.message, true);
      }
    };
  }

  if (logoutBtn) {
    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        showStatus("Logged out successfully.");
      }).catch((error) => {
        console.error("Logout error:", error);
      });
    };
  }

  onAuthStateChanged(auth, (user) => {
    console.log("Auth state changed:", user ? user.email : "No user");
    if (user) {
      window.firebaseUser = user;
      if (userStatus) userStatus.textContent = "✅ Signed in as: " + user.email;
      if (logoutBtn) logoutBtn.style.display = "inline-block";
      if (loginForm) loginForm.style.display = "none";
      uploadButtons.forEach(btn => btn.style.display = "inline-block");
    } else {
      window.firebaseUser = null;
      if (userStatus) userStatus.textContent = "❌ Not signed in";
      if (logoutBtn) logoutBtn.style.display = "none";
      if (loginForm) loginForm.style.display = "block";
      uploadButtons.forEach(btn => btn.style.display = "none");
    }
  });
}

// Make function available globally
window.setupAuthUI = setupAuthUI;

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof init === "function") init();
    setupAuthUI();
  });
} else {
  if (typeof init === "function") init();
  setupAuthUI();
}
</script>

<script>
const CORRECT_PASSWORD = "vlegends2025!";

function checkPassword() {
  const entered = document.getElementById('admin-pass').value;
  if (entered === CORRECT_PASSWORD) {
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('user-status').style.display = 'none';
    document.getElementById('logout-btn').style.display = 'none';
    window.adminOverride = true;
    document.querySelectorAll('.firebase-export').forEach(btn => btn.style.display = 'inline-block');
    console.log("Admin override enabled");
    
    // Set up upload button event listeners after admin login
    const tournamentBtn = document.getElementById("upload-tournament-btn");
    const matchBtn = document.getElementById("upload-match-btn");
    
    if (tournamentBtn && !tournamentBtn.onclick) {
      tournamentBtn.onclick = () => uploadToFirebase('tournament_results.csv', generateTournamentCSV());
    }
    
    if (matchBtn && !matchBtn.onclick) {
      matchBtn.onclick = () => uploadToFirebase('match_scores.csv', generateMatchCSV());
    }
  } else {
    document.getElementById('error-msg').textContent = "❌ Incorrect password. Try again.";
  }
}

function logout() {
  document.getElementById('admin-panel').style.display = 'none';
  document.getElementById('login-container').style.display = 'flex';
  const pwField = document.getElementById('admin-pass');
  const errorMsg = document.getElementById('error-msg');
  if (pwField) pwField.value = '';
  if (errorMsg) errorMsg.textContent = '';
  window.adminOverride = false;
  console.log("Admin logged out");
}

// Cricket tournament management code
const groups = ['A','B','C','D'];
let teamData = {}, stats = {}, matchResults = {};

function saveData() {
  try {
    const data = JSON.stringify({ teamData, stats, matchResults });
    localStorage.setItem('vl6s_data', data);
    console.log("Data saved to localStorage");
  } catch (error) {
    console.error("Error saving data:", error);
  }
}

function loadData() {
  try {
    const data = localStorage.getItem('vl6s_data');
    if (data) {
      const obj = JSON.parse(data);
      teamData = obj.teamData || {};
      stats = obj.stats || {};
      matchResults = obj.matchResults || {};
      console.log("Data loaded from localStorage");
    } else {
      // Initialize default data
      groups.forEach(g => {
        teamData[g] = Array(4).fill().map((_, i) => `Team ${g}${i+1}`);
        stats[g] = {};
        teamData[g].forEach((_, i) => stats[g][i] = { m:0, w:0, l:0, t:0, rf:0, rof:0, ra:0, roa:0 });
      });
      console.log("Initialized default data");
    }
  } catch (error) {
    console.error("Error loading data:", error);
    // Initialize default data on error
    groups.forEach(g => {
      teamData[g] = Array(4).fill().map((_, i) => `Team ${g}${i+1}`);
      stats[g] = {};
      teamData[g].forEach((_, i) => stats[g][i] = { m:0, w:0, l:0, t:0, rf:0, rof:0, ra:0, roa:0 });
    });
  }
}

function clearAll() {
  if (confirm("Are you sure you want to clear all data? This cannot be undone.")) {
    localStorage.removeItem('vl6s_data');
    location.reload();
  }
}

function convertOversToDecimal(overs) {
  const full = Math.floor(overs);
  const balls = Math.round((overs - full) * 10);
  return full + (balls / 6);
}

function init() {
  console.log("Initializing cricket tournament app");
  loadData();
  renderTabs();
  renderInputs();
  renderMatches();
  renderTables();
}

function renderTabs() {
  const el = document.getElementById('tabs');
  if (!el) return;
  
  el.innerHTML = '';
  groups.forEach((g, i) => {
    const div = document.createElement('div');
    div.className = 'tab' + (i === 0 ? ' active' : '');
    div.textContent = 'Group ' + g;
    div.onclick = () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      div.classList.add('active');
      renderTables(); 
      const groupEl = document.getElementById(`group_${g}`);
      if (groupEl) groupEl.scrollIntoView({ behavior: 'smooth' });
    };
    el.appendChild(div);
  });
}

function renderInputs() {
  const el = document.getElementById('teamInputs');
  if (!el) return;
  
  el.innerHTML = '';
  groups.forEach(g => {
    const sec = document.createElement('div');
    sec.innerHTML = `<h3>Group ${g}</h3>`;
    teamData[g].forEach((name, i) => {
      const inp = document.createElement('input');
      inp.value = name;
      inp.oninput = () => {
        teamData[g][i] = inp.value || `Team ${g}${i+1}`;
        saveData(); 
        renderMatches(); 
        renderTables();
      };
      sec.appendChild(inp);
    });
    el.appendChild(sec);
  });
}

function renderMatches() {
  const el = document.getElementById('matchInputs');
  if (!el) return;
  
  el.innerHTML = '';
  groups.forEach(g => {
    for (let i=0;i<4;i++) {
      for (let j=i+1;j<4;j++) {
        const div = document.createElement('div');
        div.innerHTML = `
          <strong>${teamData[g][i]} vs ${teamData[g][j]}</strong><br>
          ${teamData[g][i]} Runs: <input id='${g}_${i}_${j}_r1' type='number' min='0'><br>
          Wickets: <input id='${g}_${i}_${j}_w1' type='number' min='0' max='10'><br>
          Overs: <input id='${g}_${i}_${j}_o1' type='number' min='0' step='0.1'><br>
          ${teamData[g][j]} Runs: <input id='${g}_${i}_${j}_r2' type='number' min='0'><br>
          Wickets: <input id='${g}_${i}_${j}_w2' type='number' min='0' max='10'><br>
          Overs: <input id='${g}_${i}_${j}_o2' type='number' min='0' step='0.1'><br>
          <button class='btn submit' onclick="submitMatch('${g}',${i},${j})">Submit</button>
          <button class='btn clear' onclick="clearMatch('${g}',${i},${j})">Clear</button>
          <button class='btn clear' onclick="noShow('${g}',${i},${j},${i})">No Show: ${teamData[g][i]}</button>
          <button class='btn clear' onclick="noShow('${g}',${i},${j},${j})">No Show: ${teamData[g][j]}</button>
          <div id='result_${g}_${i}_${j}' class='result-summary'></div>
        `;
        el.appendChild(div);
      }
    }
  });
}

function submitMatch(g, i, j) {
  const submitBtn = document.querySelector(`button[onclick="submitMatch('${g}',${i},${j})"]`);
  if (submitBtn) submitBtn.disabled = true;

  const r1 = parseInt(document.getElementById(`${g}_${i}_${j}_r1`).value) || 0;
  const o1 = parseFloat(document.getElementById(`${g}_${i}_${j}_o1`).value) || 0;
  const r2 = parseInt(document.getElementById(`${g}_${i}_${j}_r2`).value) || 0;
  const w1 = parseInt(document.getElementById(`${g}_${i}_${j}_w1`).value) || 0;
  const w2 = parseInt(document.getElementById(`${g}_${i}_${j}_w2`).value) || 0;
  const o2 = parseFloat(document.getElementById(`${g}_${i}_${j}_o2`).value) || 0;
  
  if (r1 < 0 || r2 < 0 || o1 <= 0 || o2 <= 0 || w1 < 0 || w2 < 0) {
    alert('Please enter valid values (runs >= 0, overs > 0, wickets >= 0)');
    if (submitBtn) submitBtn.disabled = false;
    return;
  }

  const t1 = stats[g][i], t2 = stats[g][j];
  t1.m++; t2.m++;
  t1.rf += r1; t1.rof += convertOversToDecimal(o1); t1.ra += r2; t1.roa += convertOversToDecimal(o2);
  t2.rf += r2; t2.rof += convertOversToDecimal(o2); t2.ra += r1; t2.roa += convertOversToDecimal(o1);
  
  if (r1 > r2) { t1.w++; t2.l++; }
  else if (r2 > r1) { t2.w++; t1.l++; }
  else { t1.t++; t2.t++; }

  matchResults[`${g}_${i}_${j}`] = { r1, w1, o1, r2, w2, o2 };

  saveData(); 
  renderTables();
  
  const resultEl = document.getElementById(`result_${g}_${i}_${j}`);
  if (resultEl) {
    let summary = `<strong>📊 Result:</strong><br>`;
    summary += `${teamData[g][i]} ${r1}/${w1} (${convertOversToDecimal(o1).toFixed(3)} overs)<br>`;
    summary += `${teamData[g][j]} ${r2}/${w2} (${convertOversToDecimal(o2).toFixed(3)} overs)<br>`;
    if (r1 > r2) summary += `<strong>🏆 Winner:</strong> ${teamData[g][i]}`;
    else if (r2 > r1) summary += `<strong>🏆 Winner:</strong> ${teamData[g][j]}`;
    else summary += `<strong>🤝 Match tied</strong>`;
    resultEl.innerHTML = summary;
  }
}

function clearMatch(g, i, j) {
  const key = `${g}_${i}_${j}`;
  const existing = matchResults[key];
  if (existing) {
    const t1 = stats[g][i], t2 = stats[g][j];
    t1.m--; t2.m--;

    const o1d = convertOversToDecimal(existing.o1);
    const o2d = convertOversToDecimal(existing.o2);

    t1.rf -= existing.r1; t1.rof -= o1d; t1.ra -= existing.r2; t1.roa -= o2d;
    t2.rf -= existing.r2; t2.rof -= o2d; t2.ra -= existing.r1; t2.roa -= o1d;

    if ('forfeiter' in existing) {
      if (existing.forfeiter === "both") {
        t1.l--; t2.l--;
      } else if (existing.forfeiter === i) {
        t1.l--; t2.w--;
      } else {
        t2.l--; t1.w--;
      }
    } else {
      if (existing.r1 > existing.r2) { t1.w--; t2.l--; }
      else if (existing.r2 > existing.r1) { t2.w--; t1.l--; }
      else { t1.t--; t2.t--; }
    }

    delete matchResults[key];
  }

  ['r1','o1','w1','r2','o2','w2'].forEach(x => {
    const el = document.getElementById(`${g}_${i}_${j}_${x}`);
    if (el) el.value = '';
  });

  const res = document.getElementById(`result_${g}_${i}_${j}`);
  if (res) res.innerHTML = '';

  const submitBtn = document.querySelector(`button[onclick="submitMatch('${g}',${i},${j})"]`);
  if (submitBtn) submitBtn.disabled = false;

  saveData();
  renderTables();
}

function noShow(g, i, j, forfeiter) {
  const key = `${g}_${i}_${j}`;
  const other = forfeiter === i ? j : i;
  const t1 = stats[g][i];
  const t2 = stats[g][j];
  const existing = matchResults[key];

  if (!existing) {
    t1.m++; t2.m++;
    if (forfeiter === i) { t1.l++; t2.w++; }
    else { t2.l++; t1.w++; }

    matchResults[key] = {
      r1: 0, w1: 0, o1: 0,
      r2: 0, w2: 0, o2: 0,
      forfeiter
    };
  } else if ('forfeiter' in existing && existing.forfeiter !== "both" && existing.forfeiter !== forfeiter) {
    if (existing.forfeiter === i) { t1.l--; t2.w--; }
    else { t2.l--; t1.w--; }

    t1.l++; t2.l++;
    matchResults[key].forfeiter = "both";
  } else {
    return;
  }

  const submitBtn = document.querySelector(`button[onclick="submitMatch('${g}',${i},${j})"]`);
  if (submitBtn) submitBtn.disabled = true;

  const res = document.getElementById(`result_${g}_${i}_${j}`);
  if (res) {
    const forfeiterLabel = matchResults[key].forfeiter;
    if (forfeiterLabel === "both") {
      res.innerHTML = `<strong>🚫 No Show:</strong><br>Both teams forfeited. Match void.`;
    } else {
      res.innerHTML = `<strong>🚫 No Show:</strong><br>${teamData[g][forfeiter]} forfeited. ${teamData[g][other]} wins.`;
    }
  }

  saveData();
  renderTables();
}

function renderTables() {
  const el = document.getElementById('tables');
  if (!el) return;
  
  el.innerHTML = '';
  groups.forEach(g => {
    const list = teamData[g].map((name, i) => {
      const s = stats[g][i], pts = s.w*2 + s.t;
      const nrr = s.rof && s.roa ? ((s.rf/s.rof)-(s.ra/s.roa)).toFixed(3) : '0.000';
      return { name, ...s, pts, nrr };
    }).sort((a,b)=>b.pts - a.pts || b.nrr - a.nrr);
    
    const table = `<h3 id="group_${g}">Group ${g}</h3><table>
    <tr><th>Team</th><th>Mat</th><th>W</th><th>L</th><th>T</th><th>NRR</th><th>Pts</th></tr>
    ${list.map((t,i)=>`<tr class='${i<2?'highlight':''}'><td>${t.name}</td><td>${t.m}</td><td>${t.w}</td><td>${t.l}</td><td>${t.t}</td><td>${t.nrr}</td><td>${t.pts}</td></tr>`).join('')}
    </table>`;
    
    const sec = document.createElement('div');
    sec.innerHTML = table;
    el.appendChild(sec);
  });
}

function generateTournamentCSV() {
  let csv = 'Group,Team,Mat,W,L,T,NRR,Points\n';
  groups.forEach(g => {
    teamData[g].forEach((name, i) => {
      const s = stats[g][i];
      const pts = s.w*2 + s.t;
      const nrr = (s.rof && s.roa) ? ((s.rf/s.rof)-(s.ra/s.roa)).toFixed(3) : '0.000';
      csv += `${g},"${name.replace(/"/g, '""')}",${s.m},${s.w},${s.l},${s.t},${nrr},${pts}\n`;
    });
  });
  console.log("Generated tournament CSV:", csv.substring(0, 200) + "...");
  return csv;
}

function generateMatchCSV() {
  let csv = 'Group,Team1,Team1_Runs,Team1_Wickets,Team1_Overs,Team2,Team2_Runs,Team2_Wickets,Team2_Overs,Result\n';
  Object.keys(matchResults).forEach(key => {
    const [g, i, j] = key.split('_');
    const match = matchResults[key];
    const team1 = teamData[g][i];
    const team2 = teamData[g][j];
    
    let result = 'Tie';
    if ('forfeiter' in match) {
      if (match.forfeiter === "both") result = 'Both forfeited';
      else result = `${teamData[g][match.forfeiter]} forfeited`;
    } else {
      if (match.r1 > match.r2) result = `${team1} won`;
      else if (match.r2 > match.r1) result = `${team2} won`;
    }
    
    csv += `${g},"${team1.replace(/"/g, '""')}",${match.r1},${match.w1},${match.o1.toFixed(1)},"${team2.replace(/"/g, '""')}",${match.r2},${match.w2},${match.o2.toFixed(1)},"${result.replace(/"/g, '""')}"\n`;
  });
  console.log("Generated match CSV:", csv.substring(0, 200) + "...");
  return csv;
}

// Initialize the app when the page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>